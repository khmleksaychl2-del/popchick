<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Bird Game with High Score</title>
  <style>
    canvas {
      border: 1px solid black;
      display: block;
      margin: auto;
      background-color: skyblue;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="320" height="480"></canvas>

  <!-- Firebase SDK (เวอร์ชัน 8) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script>
    // ตั้งค่า Firebase ของคุณ
    const firebaseConfig = {
      apiKey: "AIzaSyDxX_805fRq2jRa6XejsEjytHovfLz-2bQ",
      authDomain: "bird-game-ce895.firebaseapp.com",
      projectId: "bird-game-ce895",
      storageBucket: "bird-game-ce895.appspot.com",
      messagingSenderId: "98680409790",
      appId: "1:98680409790:web:82db90d15e0826cf6d58ef"
    };

    // เริ่มต้น Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ---------------- โค้ดเกม ----------------
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    let birdY = 200;
    let birdVelocity = 0;
    let gravity = 0.5;
    let score = 0;
    let highScore = 0;
    let gameOver = false;

    // โหลดคะแนนสูงสุดจาก Firebase
    function loadHighScore() {
      db.collection("Player")
        .orderBy("score", "desc")
        .limit(1)
        .get()
        .then((querySnapshot) => {
          if (!querySnapshot.empty) {
            highScore = querySnapshot.docs[0].data().score;
          }
        })
        .catch((error) => {
          console.error("Error loading high score:", error);
        });
    }
    loadHighScore();

    // เมื่อกดปุ่มหรือกดคีย์บอร์ด
    document.addEventListener('keydown', () => {
      if (!gameOver) {
        birdVelocity = -8;
        score++; // เพิ่มคะแนนทุกครั้งที่กระพือปีก
      } else {
        restartGame();
      }
    });

    canvas.addEventListener('click', () => {
      if (!gameOver) {
        birdVelocity = -8;
        score++;
      } else {
        restartGame();
      }
    });

    function update() {
      if (!gameOver) {
        birdVelocity += gravity;
        birdY += birdVelocity;

        // ถ้าตกพื้น
        if (birdY > canvas.height) {
          gameOver = true;
          saveScore(score);
        }
      }
    }

    function draw() {
      ctx.fillStyle = 'skyblue';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = 'yellow';
      ctx.beginPath();
      ctx.arc(50, birdY, 10, 0, Math.PI * 2);
      ctx.fill();

      ctx.fillStyle = 'black';
      ctx.font = '20px Arial';
      ctx.fillText("Score: " + score, 10, 20);
      ctx.fillText("High Score: " + highScore, 10, 45);

      if (gameOver) {
        ctx.fillText("Game Over - Press any key", 10, canvas.height / 2);
      }
    }

    function gameLoop() {
      update();
      draw();
      requestAnimationFrame(gameLoop);
    }

    function restartGame() {
      birdY = 200;
      birdVelocity = 0;
      score = 0;
      gameOver = false;
    }

    // ---------------- บันทึกคะแนนลง Firebase ----------------
    function saveScore(finalScore) {
      db.collection("Player").add({
        score: finalScore,
        time: new Date()
      })
      .then(() => {
        console.log("บันทึกคะแนนสำเร็จ!");
        if (finalScore > highScore) {
          highScore = finalScore; // อัพเดทคะแนนสูงสุดในเกมทันที
        }
      })
      .catch((error) => {
        console.error("เกิดข้อผิดพลาดในการบันทึก: ", error);
      });
    }

    gameLoop();
  </script>
</body>
</html>
